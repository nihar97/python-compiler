# Top-level Makefile for Project 1.
# 
# Targets:
#   make [ default ]        Compiles sources in src directory
#   make check              Compiles sources and runs tests.  The parameter
#                            APYC indicates which compiler to run.
#   make clean              Removes unnecessary files, including those that
#                            are reproducible.
#   make depend	     Compute makefile dependencies and store
#                            in .depend.  Use this whenever you add a new
#                            source file or change an #include line.
#   make really-clean       Same as 'clean', also removes the file .depend.
#

APYC = $(shell echo `pwd`/../apyc)

# Bison program
BISON = bison

# Options on Bison command line
BISON_FLAGS = -v

# Flex program
FLEX = flex

# Options on Flex command line
FLEX_FLAGS = 

# Any -L or -l options needed for linking.
LOADLIBS = 

# C++ compiler
CXX = c++ -std=c++11

# Options passed to the C++ compiler
CXXFLAGS = -g -Wall -Wno-unused-variable -Wno-unused-function -Wno-sign-compare

# List of normal C++ sources.  Add any new ones here
SRCS = apyc.cc ast.cc post1.cc unifier.cc environ.cc decls.cc types.cc \
	exprs.cc stmts.cc resolver.cc code.cc

# C++ top-level (i.e., as opposed to #included) sources that are generated
# by other rules in this Makefile.
GENERATED_SRCS = apyc-parser.cc

# List of all C++ object files
OBJS = $(SRCS:.cc=.o) $(GENERATED_SRCS:.cc=.o)

# List of all C++ sources generated by tools
OTHER_SRCS = $(GENERATED_SRCS) apyc-lexer.cc

.PHONY: default compile check check1 check2 clean really-clean depend

%.cc: %.y
	$(BISON) $(BISON_FLAGS) -o $@ $<

%.cc: %.l
	$(FLEX) $(FLEX_FLAGS) -o $@ $<

default: compile

compile: ../apyc

../apyc: $(OBJS) 
	$(CXX) -g -o $@ $(OBJS) $(LOADLIBS)

check: 
	$(MAKE) -C .. APYC=$(APYC) check

check1: 
	$(MAKE) -C .. APYC=$(APYC) check1

check2: 
	$(MAKE) -C .. APYC=$(APYC) check2

clean:
	$(RM) *~ *.o *.pyc *.ast *.tab.c *.output 
	$(RM) tests/*~ tests/*/*~
	$(RM) $(OTHER_SRCS) parser-sentinel

really-clean: clean
	$(RM) .depend

apyc-parser.cc: apyc-parser.y apyc-lexer.cc

apyc-lexer.cc: apyc-lexer.l

# Dependencies

.depend:
	touch .depend
	$(MAKE) depend

depend: $(OTHER_SRCS)
	$(RM) .depend
	$(CXX) -MM -std=c++0x $(INCLUDES) $(OBJS:.o=.cc) > .depend

-include .depend
